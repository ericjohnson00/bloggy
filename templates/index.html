<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ¤˜ SwamPStoner ðŸ¤˜</title>
    <script defer src="/static/script.js"></script>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/nav.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Creepster&family=Silkscreen:wght@400;700&family=VT323&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/ad3ef7551b.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <header>
      <nav>
        <div class="logo">
          <a href="{{ url_for('index') }}"><p>SWAMP STONER</p> </a>
        </div>

        <div class="nav-links">
          <ul>
            <li><a href="{{ url_for('index') }}">HOME</a></li>
            <li><a href="{{ url_for('contact') }}">TERMINAL</a></li>
            <li><a href="{{ url_for('links') }}">LINKS</a></li>
          </ul>
        </div>

        <div class="nav-menu">
          <ul>
            <li><a href="{{ url_for('index') }}">HOME</a></li>
            <li><a href="{{ url_for('contact') }}">TERMINAL</a></li>
            <li><a href="{{ url_for('links') }}">LINKS</a></li>
          </ul>
        </div>

        <div class="hamburger">
          <div class="bar bar1"></div>
          <div class="bar bar2"></div>
          <div class="bar bar3"></div>
        </div>
      </nav>
    </header>

    <main>
      <div id="posts-container" class="posts-grid"></div>
    </main>

    <div id="post-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modal-post-content"></div>
      </div>
    </div>

    <!--  -->

    <!-- Add this before the posts-container div in the main section -->
    <div class="post-form-container">
      <button id="new-post-btn" class="btn">Create New Post</button>

      <div id="post-form" class="modal">
        <div class="modal-content">
          <span class="close-form">&times;</span>
          <form id="create-post-form">
            <input type="text" name="title" placeholder="Title" required />
            <input type="text" name="author" placeholder="Author" required />
            <textarea name="content" placeholder="Content" required></textarea>
            <div class="image-upload">
              <label for="images">Images (optional):</label>
              <input
                type="file"
                name="images[]"
                id="images"
                multiple
                accept="image/*"
              />
            </div>
            <button type="submit">Post</button>
          </form>
        </div>
      </div>
    </div>

    <!--  -->

    <div id="pagination" class="pagination">
      <button id="prev-page" class="pagination-btn">&laquo; Previous</button>
      <div id="page-numbers" class="page-numbers"></div>
      <button id="next-page" class="pagination-btn">Next &raquo;</button>
    </div>

    <script>
      let currentPage = 1;
      const postsPerPage = 6;

      async function loadPosts(page = 1) {
        const response = await fetch(
          `/api/posts?page=${page}&per_page=${postsPerPage}`
        );
        const data = await response.json();

        const container = document.getElementById("posts-container");
        container.innerHTML = data.posts
          .map(
            (post) => `
                  <div class="post-card" onclick="openPost(${post.id})">
                      ${
                        post.images && post.images.length > 0
                          ? `<img src="/static/uploads/${post.images[0]}" alt="Post image" class="post-thumbnail">`
                          : ""
                      }
                      <h2>${post.title}</h2>
                      <p>${post.content.substring(0, 150)}...</p>
                      <div class="post-meta">
                          <span class="author">By ${post.author}</span>
                          <span class="date">${new Date(
                            post.created_date
                          ).toLocaleString("en-US", {
                            timeZone: "America/Chicago",
                          })}</span>
                      </div>
                  </div>
              `
          )
          .join("");

        // Update pagination
        updatePagination(data.current_page, data.total_pages);
      }

      function updatePagination(currentPage, totalPages) {
        const prevBtn = document.getElementById("prev-page");
        const nextBtn = document.getElementById("next-page");
        const pageNumbers = document.getElementById("page-numbers");

        // Update previous/next buttons
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        // Update page numbers
        pageNumbers.innerHTML = "";

        // Calculate range of pages to show
        let start = Math.max(1, currentPage - 2);
        let end = Math.min(totalPages, currentPage + 2);

        // Always show first page
        if (start > 1) {
          pageNumbers.innerHTML += `
                  <span class="page-number" onclick="loadPosts(1)">1</span>
                  ${start > 2 ? "<span>...</span>" : ""}
              `;
        }

        // Show page numbers
        for (let i = start; i <= end; i++) {
          pageNumbers.innerHTML += `
                  <span class="page-number ${
                    i === currentPage ? "active" : ""
                  }" 
                        onclick="loadPosts(${i})">${i}</span>
              `;
        }

        // Always show last page
        if (end < totalPages) {
          pageNumbers.innerHTML += `
                  ${end < totalPages - 1 ? "<span>...</span>" : ""}
                  <span class="page-number" onclick="loadPosts(${totalPages})">${totalPages}</span>
              `;
        }
      }

      // Add event listeners for pagination buttons
      document.getElementById("prev-page").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          loadPosts(currentPage);
        }
      });

      document.getElementById("next-page").addEventListener("click", () => {
        currentPage++;
        loadPosts(currentPage);
      });

      async function openPost(id) {
        const response = await fetch(`/api/post/${id}`);
        const post = await response.json();

        const modal = document.getElementById("post-modal");
        const content = document.getElementById("modal-post-content");

        content.innerHTML = `
                <h2>${post.title}</h2>
                <div class="post-meta">
                    <span class="author">By ${post.author}</span>
                    <span class="date">${new Date(
                      post.created_date
                    ).toLocaleString("en-US", {
                      timeZone: "America/Chicago",
                    })}</span>
                </div>
                <div class="post-images">
                    ${post.images
                      .map(
                        (img) => `
                        <img src="/static/uploads/${img}" alt="Post image">
                    `
                      )
                      .join("")}
                </div>
                <div class="post-content">${post.content}</div>
            `;

        modal.style.display = "block";

        // Prevent body scrolling when modal is open
        document.body.style.overflow = "hidden";
      }

      // Updated close function to restore body scrolling
      document.querySelector(".close").onclick = function () {
        document.getElementById("post-modal").style.display = "none";
        document.body.style.overflow = "auto";
      };

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("post-modal");
        if (event.target == modal) {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
        }
      };

      document.addEventListener("DOMContentLoaded", loadPosts);
    </script>

    <!-- filepath: /c:/projects/bloggy/index.html -->
    <script>
      // ...existing code...

      // Post Form Functionality
      const newPostBtn = document.getElementById("new-post-btn");
      const postForm = document.getElementById("post-form");
      const closeForm = document.querySelector(".close-form");

      newPostBtn.onclick = function () {
        postForm.style.display = "block";
        document.body.style.overflow = "hidden";
      };

      closeForm.onclick = function () {
        postForm.style.display = "none";
        document.body.style.overflow = "auto";
      };

      document.getElementById("create-post-form").onsubmit = async function (
        e
      ) {
        e.preventDefault();

        const formData = new FormData(this);

        try {
          const response = await fetch("/api/post", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            postForm.style.display = "none";
            document.body.style.overflow = "auto";
            this.reset();
            loadPosts(); // Refresh the posts
          } else {
            alert("Error creating post");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error creating post");
        }
      };
    </script>
  </body>
</html>
